<%
const content = theme.footer.content?.replace('{author.name}', (config.author || 'Anonymity'))
  ?.replace('{theme.name}', stellar_info('name'))
  ?.replace('{theme.version}', stellar_info('version'))
  ?.replace('{theme.tree}', stellar_info('tree'));

function layoutDiv() {
  let el = '';
  el += `<footer class="page-footer${scrollreveal(' ')} footnote">`;
  el += '<hr>';
  // sitemap
  if (theme.footer.sitemap && Object.keys(theme.footer.sitemap).length > 0) {
    el += '<div class="sitemap">';
    for (const group of Object.keys(theme.footer.sitemap)) {
      const items = theme.footer.sitemap[group];
      if (!items || items.length === 0) {
        continue;
      }
      el += '<div class="sitemap-group">';
      el += `<span class="fs15">${group}</span>`;
      items.forEach((item) => {
        el += `<a href="${url_for(md_link(item))}">${__(md_text(item))}</a>`;
      });
      el += '</div>';
    }
    el += '</div>';
  }
  // footer
  el += '<div class="text">';
  if (content) {
    el += markdown(content);
  }
  el += '</div></footer>';
  return el;
}
%>
<%- layoutDiv() %>

<% if (theme.footer.social && Object.keys(theme.footer.social).length > 0) { %>
  <div class="social-icons">
    <% 
      // éå† theme.footer.social å¯¹è±¡
      for (const [key, item] of Object.entries(theme.footer.social)) {
    %>
      <a href="<%= item.url %>" class="social-icon">
        <%- item.icon %>
      </a>
    <% } %>
  </div>
<% } %>
<script>
document.addEventListener('DOMContentLoaded', function() {
  let currentMode = 'sun'; // é»˜è®¤å¤©æ°”æ¨¡å¼
  const weatherIcon = document.getElementById('toggleWeather');
  const statusMessage = document.createElement('div');
  
  // è®¾ç½®çŠ¶æ€æç¤ºæ¡†çš„æ ·å¼
  statusMessage.style.position = 'fixed';
  statusMessage.style.top = '20px';
  statusMessage.style.left = '50%';
  statusMessage.style.transform = 'translateX(-50%)';
  statusMessage.style.padding = '10px 20px';
  statusMessage.style.backgroundColor = '#000';
  statusMessage.style.color = '#fff';
  statusMessage.style.borderRadius = '5px';
  statusMessage.style.display = 'none';
  statusMessage.style.zIndex = '9999';
  document.body.appendChild(statusMessage);

  // å¦‚æœé¡µé¢å­˜åœ¨å¤©æ°”å›¾æ ‡ï¼Œåˆå§‹åŒ–
  if (!weatherIcon) return;

  // è·å–ä¹‹å‰ä¿å­˜çš„å¤©æ°”çŠ¶æ€
  const savedMode = localStorage.getItem('weatherMode');
  if (savedMode) {
    currentMode = savedMode;
    setWeatherMode(savedMode, false); // ä¸æç¤ºï¼Œç›´æ¥æ¢å¤çŠ¶æ€
  }

  // ç”¨æˆ·ç‚¹å‡»å¤©æ°”å›¾æ ‡åˆ‡æ¢å¤©æ°”æ¨¡å¼
  weatherIcon.closest('a').addEventListener('click', function(e) {
    e.preventDefault();

    if (currentMode === 'sun') {
      setWeatherMode('snow', true);
      currentMode = 'snow';
    } else if (currentMode === 'snow') {
      setWeatherMode('rain', true);
      currentMode = 'rain';
    } else if (currentMode === 'rain') {
      setWeatherMode('sun', true);
      currentMode = 'sun';
    }
  });

  // è®¾ç½®å¤©æ°”æ¨¡å¼
  function setWeatherMode(mode, showTip = false) {
    // å¸è½½å½“å‰æ‰€æœ‰ç‰¹æ•ˆ
    removeScripts();

    if (mode === 'snow') {
      weatherIcon.src = '/assets/icons/snow.svg';
      loadScript('snow');
      if (showTip) statusMessage.textContent = 'â„ï¸ Snow â„ï¸';
    } else if (mode === 'rain') {
      weatherIcon.src = '/assets/icons/rain.svg';
      loadScript('rain');
      if (showTip) statusMessage.textContent = 'ğŸŒ§ï¸ Rain ğŸŒ§ï¸';
    } else if (mode === 'sun') {
      weatherIcon.src = '/assets/icons/sun.svg';
      if (showTip) statusMessage.textContent = 'â˜€ï¸ Sun â˜€ï¸';
    }

    // æ˜¾ç¤ºæç¤ºæ¡†
    if (showTip) {
      statusMessage.style.display = 'block';
      setTimeout(() => {
        statusMessage.style.display = 'none';
      }, 3000); // æç¤ºæ¡†æ¶ˆå¤±çš„å»¶æ—¶
    }

    // ä¿å­˜å¤©æ°”çŠ¶æ€
    localStorage.setItem('weatherMode', mode);
  }

  // åŠ¨æ€åŠ è½½ç‰¹æ•ˆè„šæœ¬
  function loadScript(mode) {
    if (mode === 'snow' && !window.__snow__) {
      const script = document.createElement('script');
      script.src = '/js/snow.js';
      script.defer = true;
      document.body.appendChild(script);
    } else if (mode === 'rain' && !window.__rain__) {
      const script = document.createElement('script');
      script.src = '/js/rain.js';
      script.defer = true;
      document.body.appendChild(script);
    }
  }

  // å¸è½½å½“å‰çš„å¤©æ°”ç‰¹æ•ˆ
  function removeScripts() {
    // æ¸…é™¤é›ªèŠ±ç‰¹æ•ˆ
    if (window.__snow__) {
      clearInterval(window.__snow__.timer);
      if (window.__snow__.canvas) {
        window.__snow__.canvas.remove();
      }
      delete window.__snow__;
    }
    
    // æ¸…é™¤é›¨å¤©ç‰¹æ•ˆ
    if (window.__rain__) {
      clearInterval(window.__rain__.timer); // åœæ­¢é›¨æ»´ç”Ÿæˆ
      const rainCanvas = document.querySelector('[data-rain-canvas]');
      if (rainCanvas) {
        rainCanvas.remove(); // ç§»é™¤é›¨æ»´å®¹å™¨
      }
      delete window.__rain__; // æ¸…é™¤å…¨å±€å˜é‡
    }
  }
});

</script>